<!DOCTYPE HTML>
<div id="html">
    <head>
        <title>Playing around with Web Audio API</title>
    </head>
    <body>
        <h1>Let the music play!</h1>

        <audio id="audio" controls>
            <source src="DOt_-_05_-_IMF.mp3" type="audio/mpeg">
        </audio>

        <div style="clear:both"></div>

        <canvas id="canvas" width="800" height="600"></canvas>

        <script>
            function visualize(frequencyData) {
                let canvasWidth = 800;
                let canvasHeight = 600;

                let c = document.getElementById("canvas");
                let ctx = c.getContext("2d");

                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0,0,800,600);

                ctx.fillStyle = "#FF0000";
                let barWidth = canvasWidth / frequencyData.length;
                frequencyData.forEach((datapoint, index) => {
                    let leftX = index * barWidth;
                    let rightX = leftX + barWidth;
                    let topY = canvasHeight-datapoint;
                    let bottomY = canvasHeight;

                    ctx.fillRect(leftX, topY, rightX, bottomY);
                });

            }


            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var audioElement = document.querySelector('audio');
            var source = audioCtx.createMediaElementSource(audioElement);

            var analyser = audioCtx.createAnalyser();
            source.connect(analyser);
            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.0;
            var bufferLength = analyser.frequencyBinCount;

            setInterval(() =>{
                var dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                visualize(dataArray);
            }, 50);

            analyser.connect(audioCtx.destination);
        </script>
    </body>
</div>
